(window.webpackJsonp=window.webpackJsonp||[]).push([[48],{1177:function(e,t,a){},1178:function(e,t,a){},1179:function(e,t,a){},1327:function(e,t,a){"use strict";a.r(t);var n=a(6),r=a(0),c=a.n(r),i=a(180),o=a(24),s=a(33),l=a(12),u=a(617),m=a(31),d=a(55),f=a(73),h=a(684),p=a(703),g=a(671),b=a.n(g),E=(a(638),a(340)),v=a(341),_=a(173),j=a(336),O=a(629);a(370);var w=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:5,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:100,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:2,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1.5,r=0;return new Array(t).fill(0).map(function(t,c){var i=Math.sqrt(c+.3)*e*n;return r+=Math.asin(1/i)*e*a,r%=2*Math.PI,{x:Math.cos(r)*i,y:Math.sin(r)*i,angle:r}})},S=function(e){var t=Object(d.a)({marginTop:0,marginRight:0,marginBottom:0,marginLeft:0},e);return Object(d.a)(Object(d.a)({},t),{},{boundedHeight:Math.max(t.height-t.marginTop-t.marginBottom,0),boundedWidth:Math.max(t.width-t.marginLeft-t.marginRight,0)})},y=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=Object(r.useRef)(),a=S(e),c=Object(r.useState)(0),i=Object(n.a)(c,2),o=i[0],s=i[1],l=Object(r.useState)(0),u=Object(n.a)(l,2),m=u[0],f=u[1];Object(r.useEffect)(function(){if(!a.width||!a.height){var e=t.current,n=new O.a(function(e){if(Array.isArray(e)&&e.length){var t=e[0];o!=t.contentRect.width&&s(t.contentRect.width),m!=t.contentRect.height&&f(t.contentRect.height)}});return n.observe(e),function(){return n.unobserve(e)}}},[]);var h=S(Object(d.a)(Object(d.a)({},a),{},{width:a.width||o,height:a.height||m}));return[t,h]},x=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"0px",a=Object(r.useState)(!1),c=Object(n.a)(a,2),i=c[0],o=c[1];return Object(r.useEffect)(function(){var a=new IntersectionObserver(function(e){var t=Object(n.a)(e,1)[0];o(t.isIntersecting)},{rootMargin:t});return e.current&&a.observe(e.current),function(){a.unobserve(e.current)}},[]),i},N=(a(179),a(1177),Object(f.b)([1e3,-100],p.d),{marginTop:0,marginRight:0,marginBottom:0,marginLeft:0}),F=[w(5,600,2,2.5),w(5,600,3,3.5),w(5,600,2.3,1.75),w(5,600,3.9,4.1),w(5,600,2.5,1.6),w(5,600,2.3,2.9),w(5,600,4.3,1.9),w(5,600,9.12,2),w(5,600,6.98,2),w(5,600,6.28,2),w(5,600,6.25,2),w(5,600,6.07,2),w(5,600,5.93,2),w(5,600,6.28,1.59),w(5,600,6.31,2.29)],D=function(){var e=y(N),t=Object(n.a)(e,2),a=t[0],i=t[1],o=Object(r.useRef)({}),s=Object(r.useRef)(),l=x(a),u=Object(r.useRef)(),m=Object(r.useRef)([]),f=Object(r.useRef)(F[0].map(function(e){return Object(d.a)(Object(d.a)({},e),{},{vx:.6,vy:.6})})),p=Object(r.useRef)(),g=Object(r.useRef)(Object(h.f)("#628BD3"));Object(r.useEffect)(function(){u.current=l},[l]),Object(r.useEffect)(function(){m.current=[i.width/2,i.height/2],p.current&&p.current.force("x",Object(E.a)(function(e,t){return i.width/2})).force("y",Object(v.a)(function(e,t){return i.height/2})),o.current=i},[i.width,i.height]);Object(r.useEffect)(function(){p.current=Object(_.a)().force("x",Object(E.a)(function(e){return m.current[0]})).force("y",Object(v.a)(function(e){return m.current[1]})).force("collide",Object(j.a)(function(){return 8.9}).strength(.6)).nodes(f.current).on("tick",function(){!function(){if(p.current.alpha(.8),u.current&&s.current){var e=s.current.getContext("2d");e.clearRect(0,0,o.current.width,o.current.height),e.globalAlpha=.9,e.fillStyle=g.current.rgb(),f.current.forEach(function(t){var a=t.x,n=t.y;e.beginPath(),e.arc(a,n,5,0,2*Math.PI,!1),e.fill()})}}(),p.current&&(p.current.tick(),g.current.h+=1)})},[]);return c.a.createElement("div",{className:"SpiralsHero",ref:a},c.a.createElement("canvas",{ref:s,width:i.width,height:i.height,onMouseMove:function(e){var t=[e.clientX,e.clientY];m.current=t;var a=F[Math.floor(Math.random()*F.length)];p.current.force("x",Object(E.a)(function(e,t){return m.current[0]+a[t].x}).strength(.3)).force("y",Object(v.a)(function(e,t){return m.current[1]+a[t].y}).strength(.3)),f.current.forEach(function(e,t){e.x=f.current[0].x,e.y=f.current[0].y})}}),c.a.createElement("div",{className:"SpiralsHero__text"},c.a.createElement("h1",null,"Use the Force"),c.a.createElement("h3",null,"Speeding up force simulations with spirals")))},M=a(123),U=a(95),k=(a(1178),Object(f.b)([1e3,-100],p.d)),R=k.ticks(9).map(function(e){return[e,k(e)]}).slice(1).reverse(),I=function(e){var t=e.r,a=void 0===t?5:t,i=e.num,o=void 0===i?600:i,l=e.angleDiff,u=void 0===l?2:l,m=e.distance,d=void 0===m?1.5:m,f=e.doUseNans,h=void 0!==f&&f,p=e.doUseForce,g=void 0!==p&&p,O=e.doUseSpiral,S=void 0!==O&&O,N=e.doStopWhenOffScreen,F=void 0!==N&&N,D=e.hasMovementTicks,I=void 0!==D&&D,T=e.onDurationUpdate,C=void 0===T?function(){}:T,P=Object(r.useState)(a||5),A=Object(n.a)(P,2),H=A[0],z=A[1],L=Object(r.useState)(o||600),W=Object(n.a)(L,2),q=W[0],B=W[1],V=Object(r.useState)(u||2),J=Object(n.a)(V,2),X=J[0],Y=J[1],G=Object(r.useState)(d||1.5),K=Object(n.a)(G,2),Q=K[0],Z=K[1],$=Object(r.useState)(null),ee=Object(n.a)($,2),te=ee[0],ae=ee[1],ne=Object(r.useState)(null),re=Object(n.a)(ne,2),ce=re[0],ie=re[1],oe=y(),se=Object(n.a)(oe,2),le=se[0],ue=se[1],me=H*(ue.width<800?ue.width/500+.1:1),de=Object(r.useRef)(),fe=Object(r.useRef)(),he=Object(r.useRef)(),pe=x(le),ge=Object(r.useRef)();function be(){if(fe.current){var e=fe.current.getContext("2d");e.clearRect(0,0,ue.width,ue.height),e.fillStyle="#9980FA",de.current.forEach(function(t){var a=t.x,n=t.y,r=t.movement;e.fillStyle=k(r)||"#9980FA",e.beginPath(),e.arc(a+ue.width/2,n+ue.height/2,me,0,2*Math.PI,!1),e.fill()})}}Object(r.useEffect)(function(){ge.current=pe},[pe]),Object(r.useEffect)(function(){B(o)},[o]),Object(r.useEffect)(function(){Y(u)},[u]),Object(r.useEffect)(function(){Z(d)},[d]),Object(r.useEffect)(function(){ie(ce+1),he.current=ce+1},[o,g,S,H,q,X,Q,F&&pe]),Object(r.useEffect)(function(){he.current=ce},[ce]);var Ee=function(){var e=S?w(me,q,X,Q):new Array(q).fill(0).map(function(){return h?{}:{x:0,y:0}});if(de.current=e,g){var t=new Date,a=Object(_.a)().force("x",Object(E.a)(function(e){return e.x})).force("y",Object(v.a)(function(e){return e.y})).force("collide",Object(j.a)(function(){return me+2}).strength(.6)).nodes(de.current).stop(),n=!0,r=de.current,c=0;!function e(){if(n)if(he.current==ce){var i=r.map(function(e,t){return a=e,n=de.current[t],Math.sqrt(Math.pow(Math.abs(a.x-n.x),2)+Math.pow(Math.abs(a.y-n.y),2));var a,n}),o=function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).reduce(function(e,t){return+e+ +t},[])}(i)/de.current.length;if(de.current.forEach(function(e,t){e.movement||(e.movement=0),e.movement+=i[t]}),!(c%4)){var s=(new Date-t)/1e3;ae(s)}if(o<.03&&c>12||F&&!ge.current){var l=(new Date-t)/1e3;ae(l),C(l),n=!1}r=de.current.map(function(e){return{x:e.x,y:e.y}}),c++,a.tick(),be(),requestAnimationFrame(e)}else n=!1}()}else be()};Object(r.useEffect)(function(){Ee()},[ce]);return c.a.createElement("div",{className:"SpiralsForceDemo",ref:le},g&&c.a.createElement(c.a.Fragment,null,c.a.createElement("h6",{className:"SpiralsForceDemo__time"},"Duration:",c.a.createElement("div",{className:"SpiralsForceDemo__time__numbers"},te?Object(M.b)(",.1f")(te):"-"),"seconds"),c.a.createElement(U.a,{className:"SpiralsForceDemo__refresh",onClick:function(){ie(ce+1)}},c.a.createElement(s.a,{name:"refresh",key:ce}),"Restart simulation")),I&&c.a.createElement("div",{className:"SpiralsForceDemo__ticks"},c.a.createElement("div",{className:"SpiralsForceDemo__ticks__label"},"More movement ",c.a.createElement(s.a,{name:"arrow",direction:"e",size:"s"})),R.map(function(e){var t=Object(n.a)(e,2),a=t[0],r=t[1];return c.a.createElement("div",{key:a,className:"SpiralsForceDemo__ticks__item",style:{background:r}})})),S&&c.a.createElement("div",{className:"SpiralsForceDemo__sliders"},c.a.createElement("div",{className:"SpiralsForceDemo__slider-group"},c.a.createElement("div",{className:"SpiralsForceDemo__slider-group__labels"},c.a.createElement("h6",null,"r"),c.a.createElement("h6",null,H)),c.a.createElement(b.a,{className:"SpiralsForceDemo__slider",value:H,min:0,max:7,onChange:z})),c.a.createElement("div",{className:"SpiralsForceDemo__slider-group"},c.a.createElement("div",{className:"SpiralsForceDemo__slider-group__labels"},c.a.createElement("h6",null,"num"),c.a.createElement("h6",null,o)),c.a.createElement(b.a,{className:"SpiralsForceDemo__slider",value:q,min:0,max:1e3,onChange:B})),c.a.createElement("div",{className:"SpiralsForceDemo__slider-group"},c.a.createElement("div",{className:"SpiralsForceDemo__slider-group__labels"},c.a.createElement("h6",null,"angleDiff"),c.a.createElement("h6",null,X)),c.a.createElement(b.a,{className:"SpiralsForceDemo__slider",value:X,min:0,max:10,step:.01,onChange:Y})),c.a.createElement("div",{className:"SpiralsForceDemo__slider-group"},c.a.createElement("div",{className:"SpiralsForceDemo__slider-group__labels"},c.a.createElement("h6",null,"distance"),c.a.createElement("h6",null,Q)),c.a.createElement(b.a,{className:"SpiralsForceDemo__slider",value:Q,min:0,max:3,step:.01,onChange:Z}))),c.a.createElement("canvas",{ref:fe,width:ue.width,height:ue.height}))},T=(a(1179),t.default=function(){var e=Object(r.useState)("..."),t=Object(n.a)(e,2),a=t[0],d=t[1],f=Object(r.useState)({}),h=Object(n.a)(f,2),p=h[0],g=h[1];return c.a.createElement("div",{className:"Spirals"},c.a.createElement(i.Helmet,null,c.a.createElement("meta",{charSet:"utf-8"}),c.a.createElement("title",null,"Speeding up force simulations with spirals"),c.a.createElement("link",{rel:"canonical",href:"https://wattenberger.com/blog/spirals"}),c.a.createElement("meta",{property:"og:type",content:"website"}),c.a.createElement("meta",{name:"description",content:"D3.js force simulations are great for implementing basic physical rules, but they can be expensive to run. Here's a trick I've used in the past to speed up those simulations."})),c.a.createElement("div",{className:"Spirals__spin-me"},c.a.createElement(s.a,{name:"paperclip",className:"Spirals__spin-me__icon"}),"This post is easiest to read in landscape mode"),c.a.createElement(D,null),c.a.createElement("div",{className:"Spirals__content"},c.a.createElement("div",{className:"Spirals__side-by-side"},c.a.createElement("div",{className:"Spirals__left"},c.a.createElement("p",null,"One of the most enjoyable parts of the ",c.a.createElement(l.a,{to:"https://d3js.org/"},"d3.js")," API is the ",c.a.createElement(l.a,{to:"https://github.com/d3/d3-force"},"d3-force")," module."),c.a.createElement("p",null,"Using ",c.a.createElement(l.a,{to:"https://github.com/d3/d3-force"},"d3-force"),", we can create a ",c.a.createElement("b",null,"force simulation")," that gives life to basic particles, moving them according to basic physical rules."),c.a.createElement(m.a,{className:"Spirals__section",isInViewChange:function(e){0==e&&g({doUseForce:!1,doUseSpiral:!1,num:100})}},c.a.createElement("p",null,"For example, say we have an array of 100 points at [0, 0]."),c.a.createElement("p",null,"Let's visualize them all!"),c.a.createElement(T,{doUseForce:!1,doUseSpiral:!1,num:100}),c.a.createElement("p",null,"Hmm, that was a little underwhelming, wasn't it?")),c.a.createElement(m.a,{className:"Spirals__section",isInViewChange:function(e){0==e&&g({doUseForce:!0,hasMovementTicks:!0,doUseSpiral:!1,num:100})}},c.a.createElement("p",null,"Let's add some physical forces to prevent our dots from overlapping, so we can see them all at once."),c.a.createElement(T,{doUseForce:!0,hasMovementTicks:!0,doUseSpiral:!1,num:100}),c.a.createElement("p",null,"Fun! We run into an issue, however, when we have more particles to animate.")),c.a.createElement(m.a,{className:"Spirals__section",isInViewChange:function(e){0==e&&g({doUseForce:!0,hasMovementTicks:!0,doUseSpiral:!1,num:600,onDurationUpdate:function(e){return d(e)}})}},c.a.createElement("p",null,"For example, let's look at how things run when we have 600 dots to animate."),c.a.createElement(T,{doUseForce:!0,hasMovementTicks:!0,doUseSpiral:!1,num:600,onDurationUpdate:function(e){return d(e)}}),c.a.createElement("p",null,"Oh boy, this simulation took ",(a+"").slice(0,4)," seconds.")),c.a.createElement(m.a,{className:"Spirals__section",isInViewChange:function(e){0==e&&g({doUseForce:!1,doUseSpiral:!0,num:600})}},c.a.createElement("p",null,"Instead, let's space our dots out by arranging them in a spiral."),c.a.createElement(u.a,{trigger:"How do I generate a spiral?",triggerExpandText:"tap to show code"},c.a.createElement(o.a,{size:"s",doWrap:!1},"const getSpiralPositions = (\n      pointRadius=5, n=100, angleDiff=3, distance=1.5\n    ) => {\n      let angle = 0\n      return new Array(n).fill(0).map((_, i) => {\n        const radius = Math.sqrt(i + 0.3) * pointRadius * distance\n        angle += Math.asin(1 / radius) * pointRadius * angleDiff\n        angle = angle % (Math.PI * 2)\n        return {\n          x: Math.cos(angle) * radius,\n          y: Math.sin(angle) * radius,\n          angle,\n        }\n      })\n    }")),c.a.createElement(T,{doUseForce:!1,doUseSpiral:!0,num:600})),c.a.createElement(m.a,{className:"Spirals__section",isInViewChange:function(e){0==e&&g({doUseForce:!0,hasMovementTicks:!0,doUseSpiral:!0})}},c.a.createElement("p",null,"Perfect! Let's compare our naive approach with starting our dots in a spiral configuration."),c.a.createElement(T,{doUseForce:!0,hasMovementTicks:!0,doUseSpiral:!0}))),c.a.createElement("div",{className:"Spirals__demo"},c.a.createElement(I,p))),c.a.createElement("div",{className:"Spirals__text"},c.a.createElement("p",null,"The astute reader might notice that we could just create a spiral with zero overlap, and we wouldn't need a simulation to space out our dots."),c.a.createElement("p",null,"In fact, this behavior is built right into d3.js! Examining ",c.a.createElement(l.a,{to:"https://github.com/d3/d3-force/blob/aa410cf32eda02bdf17c84e43d9cb3d14fb102aa/src/simulation.js#L64-L71"},"the code")," will show that d3 will initialize points in a ",c.a.createElement(l.a,{to:"https://observablehq.com/@mbostock/phyllotaxis"},"Phyllotaxis arrangement")," when no initial ",c.a.createElement("b",null,"x")," or ",c.a.createElement("b",null,"y")," value is specified."),c.a.createElement("div",{className:"Spirals__free-demo"},c.a.createElement(I,{doUseNans:!0,doUseForce:!0,r:4.3,doStopWhenOffScreen:!0})),c.a.createElement("p",null,"The default Phyllotaxis arrangement is a great option if your dots are around 3-5 pixels in radius and you want them to start around [0, 0]."),c.a.createElement("p",null,"While this makes sense for our simple demo, the real world is often more complex. I needed both in a recent project where I was displaying a dynamic number of dots over different countries. But some countries' spirals were overlapping!"),c.a.createElement("p",null,"This method could also be useful for dynamically sized dots. I hope you find this technique useful, and I can't wait to see how you use it!"))))},function(e){return window.innerWidth>800?null:c.a.createElement("div",{className:"Spirals__mobile-demo"},c.a.createElement(I,Object.assign({},e,{doStopWhenOffScreen:!0})))})},617:function(e,t,a){"use strict";var n=a(6),r=a(34),c=a(0),i=a.n(c),o=a(33),s=a(147);a(129),a(619);t.a=function(e){var t=e.trigger,a=e.triggerExpandText,l=(e.doHideIfCollapsed,e.className),u=e.children,m=Object(r.a)(e,["trigger","triggerExpandText","doHideIfCollapsed","className","children"]),d=Object(c.useState)(!1),f=Object(n.a)(d,2),h=f[0],p=f[1],g=Object(c.useRef)();return i.a.createElement("details",Object.assign({className:"Expandy Expandy--is-".concat(h?"expanded":"collapsed"," ").concat(l)},m,{ref:g,onToggle:function(e){var t=e.target.open;p(t)}}),i.a.createElement("summary",null,i.a.createElement("div",{className:"Expandy__trigger button-no-appearance"},i.a.createElement("div",{className:"Expandy__trigger__text"},i.a.createElement("b",null,t),i.a.createElement("div",{className:"Expandy__trigger__info"},a||"tap me ".concat(h?"to hide":"for more"," details"))),i.a.createElement("div",{className:"Expandy__trigger__mark"},"\u1f30")),i.a.createElement(s.a,{className:"Expandy__toggle",contents:i.a.createElement("button",{className:"button-no-appearance"},h?"Collapse me":"Expand me")},i.a.createElement("div",{className:"Expandy__toggle__arrow Expandy__toggle__arrow--up"},i.a.createElement(o.a,{name:"arrow",direction:"n",size:"s"})),i.a.createElement("div",{className:"Expandy__toggle__arrow Expandy__toggle__arrow--down"},i.a.createElement(o.a,{name:"arrow",direction:"s",size:"s"})))),i.a.createElement("div",{className:"Expandy__contents"},u))}},619:function(e,t,a){}}]);
//# sourceMappingURL=48.2fa78e6d.chunk.js.map